# CARLA Simulation Configuration
# Reference: detalhamento_RL_25_2_IEEE.md (Section III.A - System Architecture)
# Documentation: https://carla.readthedocs.io/en/latest/

# ============================================================================
# SERVER SETTINGS
# ============================================================================
server:
  host: 'localhost'  # CARLA server address (use localhost in Docker with --net=host)
  port: 2000         # Default CARLA port
  timeout: 10.0      # Connection timeout (seconds)

  # Server startup settings (used by docker-entrypoint.sh)
  render_mode: 'offscreen'  # Options: 'offscreen' (headless), 'window' (GUI)
  quality_level: 'Low'      # Options: 'Low', 'Epic' (Low for training speed)
  fps: 20                    # Server FPS (default: 20)

# ============================================================================
# WORLD SETTINGS
# ============================================================================
world:
  map_name: 'Town01'  # CARLA map (Paper specifies Town01 - Section IV.A)

  # Synchronous mode (critical for reproducibility)
  synchronous_mode: true
  fixed_delta_seconds: 0.05  # Simulation time step (20 Hz)
  no_rendering_mode: false   # Set to true for pure headless (no rendering)

  # Weather conditions (default: clear day)
  weather:
    cloudiness: 0.0       # 0-100
    precipitation: 0.0    # 0-100
    precipitation_deposits: 0.0  # 0-100
    wind_intensity: 0.0   # 0-100
    sun_azimuth_angle: 0.0       # 0-360 degrees
    sun_altitude_angle: 70.0     # -90 to 90 degrees
    fog_density: 0.0      # 0-100
    fog_distance: 0.0     # meters
    wetness: 0.0          # 0-100

  # Spectator camera (for monitoring, optional)
  spectator_transform:
    x: 150.0
    y: 200.0
    z: 50.0
    pitch: -20.0
    yaw: 0.0
    roll: 0.0

# ============================================================================
# EGO VEHICLE SETTINGS
# ============================================================================
ego_vehicle:
  # Vehicle model
  blueprint: 'vehicle.tesla.model3'  # Modern EV with good sensors

  # Spawn location (Town01 starting point)
  spawn_point:
    x: 392.0  # Town01 coordinates
    y: 326.0
    z: 1.0
    pitch: 0.0
    yaw: 0.0
    roll: 0.0

  # Vehicle physics settings
  physics:
    max_rpm: 5000.0
    moi: 1.0            # Moment of inertia
    damping_rate_full_throttle: 0.15
    damping_rate_zero_throttle_clutch_engaged: 2.0
    damping_rate_zero_throttle_clutch_disengaged: 0.35

  # Control constraints
  control:
    max_steering_angle: 70.0  # degrees
    max_throttle: 1.0
    max_brake: 1.0

  # Target speed for reward calculation
  target_speed: 30.0  # km/h (Paper: Section III.B - Reward Function)

# ============================================================================
# SENSORS (Paper: Front Camera + Kinematic Data)
# ============================================================================
sensors:
  # Front RGB Camera (primary visual input)
  # Paper Section III.B: "4 consecutive front-camera images"
  camera_rgb:
    enabled: true
    blueprint: 'sensor.camera.rgb'

    # Image dimensions (will be resized to 84x84 for CNN)
    image_size_x: 800  # Original resolution
    image_size_y: 600
    fov: 90.0          # Field of view (degrees)

    # Sensor position (front bumper, center)
    transform:
      x: 2.0   # Forward from vehicle center
      y: 0.0   # Center
      z: 1.5   # Height
      pitch: 0.0
      yaw: 0.0
      roll: 0.0

    # Capture settings
    sensor_tick: 0.05  # Capture frequency (matches simulation step)

  # Collision sensor (for safety penalty)
  collision:
    enabled: true
    blueprint: 'sensor.other.collision'

  # Lane invasion sensor (for lane keeping reward)
  lane_invasion:
    enabled: true
    blueprint: 'sensor.other.lane_invasion'

  # IMU sensor (for kinematic data: velocity, acceleration)
  imu:
    enabled: true
    blueprint: 'sensor.other.imu'
    transform:
      x: 0.0
      y: 0.0
      z: 0.0
      pitch: 0.0
      yaw: 0.0
      roll: 0.0
    sensor_tick: 0.05

# ============================================================================
# NPC TRAFFIC SETTINGS (Paper Section IV.A: 20, 50, 100 vehicles)
# ============================================================================
traffic:
  # Number of NPC vehicles (will be overridden by training script)
  num_vehicles: 50  # Default: medium density
  num_pedestrians: 0  # Focus on vehicle interaction only

  # Traffic behavior
  vehicle_behavior:
    safe: true           # Enable safe driving behavior
    aggressive: false    # Disable aggressive maneuvers
    seed: 42             # Random seed for reproducibility

  # Spawn configuration
  spawn:
    all_vehicles_spawn: false  # Spawn only specified number
    safe_spawn: true          # Ensure collision-free spawning
    car_lights_on: true       # Enable vehicle lights

  # Traffic Manager settings
  traffic_manager:
    port: 8000  # TM port (different from CARLA server)
    synchronous_mode: true  # Must match world sync mode
    hybrid_physics_mode: true  # Optimize performance
    hybrid_physics_radius: 70.0  # Full physics within radius

    # Global behavior parameters
    global_distance_to_leading_vehicle: 2.0  # meters
    global_percentage_speed_difference: 30.0  # % below speed limit
    auto_lane_change: true
    distance_to_lane_change: 10.0  # meters
    force_lane_change: false
    keep_right_rule: true

# ============================================================================
# ROUTE SETTINGS (Paper: Goal-oriented features)
# ============================================================================
route:
  # Dynamic route generation using CARLA's GlobalRoutePlanner API
  # When enabled, routes are generated using A* pathfinding on road topology
  # Start/end locations are extracted from waypoints_file for reproducibility
  use_dynamic_generation: true  # Enable dynamic waypoint generation

  # Waypoint file (from FinalProject/waypoints.txt)
  # IMPORTANT: When use_dynamic_generation=true, only the FIRST and LAST
  # waypoints are used to define start/end locations. CARLA's API generates
  # all intermediate waypoints automatically using the road network.
  waypoints_file: '/workspace/config/waypoints.txt'

  # Dynamic route generation settings (used when use_dynamic_generation=true)
  sampling_resolution: 2.0  # Distance between waypoints in meters (default: 2.0)

  # Waypoint processing (applies to both static and dynamic routes)
  lookahead_distance: 50.0  # meters (how far ahead to look)
  # commented expecting dynamic calculation for verctor obs size
  num_waypoints_ahead: 25   # Number of future waypoints to include in state

  # Coordinate transformation
  use_relative_coordinates: true  # Transform to vehicle local frame

# ============================================================================
# WAYPOINT SETTINGS (Paper: Goal-oriented features)
# ============================================================================
waypoints:
  # Waypoint file (from FinalProject/waypoints.txt)
  file_path: '/workspace/config/waypoints.txt'

  # Waypoint processing
  lookahead_distance: 5.0  # meters (how far ahead to look)
  num_waypoints_ahead: 5   # Number of future waypoints to include in state
  waypoint_spacing: 2.0    # meters (distance between waypoints)

  # Coordinate transformation
  use_relative_coordinates: true  # Transform to vehicle local frame

# ============================================================================
# EPISODE SETTINGS
# ============================================================================
episode:
  # üîß FIX: Reduced from 5000 to 1000 steps for faster learning cycles
  # At 20 Hz: 1000 steps = 50 seconds per episode (reasonable for training)
  # Original 5000 steps = 250 seconds was causing ultra-long episodes
  max_time_steps: 1000  # Maximum steps per episode (~50 seconds at 20 Hz)
  max_distance: 1000.0  # Maximum distance (meters)

  # Terminal conditions
  termination:
    on_collision: true
    on_out_of_lane: true  # 3+ seconds out of lane
    on_timeout: true
    on_goal_reached: true

  # Success criteria
  success:
    min_distance: 500.0  # meters (must travel at least this far)
    max_collisions: 0    # Zero collisions for success

# ============================================================================
# REWARD FUNCTION WEIGHTS (Paper Section III.B)
# ============================================================================
reward:
  # Component weights (must match RewardCalculator expected structure)
  weights:
    efficiency: 1.0      # INCREASED from 1.0 to strongly encourage movement
    lane_keeping: 5.0   # REDUCED from 2.0 to balance with efficiency
    comfort: 0
    safety: 1.0  # FIXED from -100.0: Penalties are already negative, positive weight needed!

  # Efficiency reward parameters (target speed tracking)
  efficiency:
    target_speed: 8.33  # m/s (30 km/h) - CODE EXPECTS M/S!
    speed_tolerance: 1.39  # m/s (5 km/h tolerance)
    overspeed_penalty_scale: 2.0

  # Lane keeping reward parameters
  lane_keeping:
    lateral_tolerance: 0.5  # meters
    heading_tolerance: 0.1  # radians (~5.7 degrees)

  # Comfort penalty (minimize jerk)
  comfort:
    weight: 0.5
    jerk_threshold: 2.0  # m/s¬≥

  # Safety penalty (collisions, off-road)
  safety:
    collision_penalty: -200.0  # Large negative reward
    off_road_penalty: -100.0

    # FIX #3: Increased lane invasion penalty from -10.0 to -50.0
    # Reference: CARLA research best practices (#file:SYSTEMATIC_FIX_ANALYSIS.md)
    # Common values:
    # - Conservative: -10.0 (old value, too weak)
    # - Moderate: -50.0 (recommended for highway scenarios) ‚Üê NEW VALUE
    # - Strict: -100.0 (dense urban traffic)
    # Rationale: With Fix #2 (route distance), off-road becomes unprofitable
    # even with -10.0 penalty. This is insurance against edge cases.
    lane_invasion_penalty: -50.0  # INCREASED from -10.0

  # Time penalty (encourage efficiency)
  time_penalty: -0.01  # Small negative per step

# ============================================================================
# LOGGING & DEBUGGING
# ============================================================================
logging:
  enable_carla_logs: false  # CARLA server logs (verbose)
  log_sensor_data: false    # Log raw sensor data (memory intensive)
  log_vehicle_state: true   # Log vehicle kinematic state
  log_rewards: true         # Log reward components

  # Visualization (for debugging)
  draw_waypoints: false     # Draw waypoints in simulation
  draw_debug_info: false    # Draw debug text/shapes

# ============================================================================
# PERFORMANCE OPTIMIZATION
# ============================================================================
performance:
  # Rendering optimization
  no_rendering_mode: false  # Pure headless mode (faster but no recording)
  quality_level: 'Low'      # Graphics quality

  # Physics optimization
  substepping: true
  max_substeps: 10
  max_substep_delta_time: 0.01

  # Memory management
  destroy_actors_on_exit: true
  garbage_collection_interval: 100  # episodes

# ============================================================================
# DOCKER-SPECIFIC SETTINGS
# ============================================================================
docker:
  # These settings are used when running in Docker container
  use_display: false  # No X11 display in container
  gpu_enabled: true   # NVIDIA GPU acceleration
  carla_root: '/home/carla/carla'  # CARLA installation path
  python_api_path: '/home/carla/carla/PythonAPI/carla'
