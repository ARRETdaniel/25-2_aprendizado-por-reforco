version: '3.8'

services:
  # Service 1: CARLA Server (0.9.16)
  carla-server:
    image: carlasim/carla:0.9.16
    container_name: carla-server-test
    runtime: nvidia
    network_mode: host
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    command: bash CarlaUE4.sh -RenderOffScreen -nosound -carla-rpc-port=2000
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c 'echo > /dev/tcp/localhost/2000' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 40s

  # Service 2: ROS 2 Bridge (Humble - Python 3.10 compatible with CARLA 0.9.16)
  ros2-bridge:
    image: ros2-carla-bridge:humble-v4
    container_name: ros2-bridge-test
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
    depends_on:
      carla-server:
        condition: service_healthy
    command: >
      bash -c "source /ros_entrypoint.sh &&
        ros2 launch carla_ros_bridge carla_ros_bridge_with_example_ego_vehicle.launch.py
        host:=localhost
        port:=2000
        timeout:=10
        synchronous_mode:=true
        fixed_delta_seconds:=0.05"
    restart: unless-stopped

networks:
  default:
    driver: bridge
