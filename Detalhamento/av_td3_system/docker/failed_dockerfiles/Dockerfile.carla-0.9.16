# TD3 Autonomous Vehicle System with CARLA 0.9.16
# Official CARLA 0.9.16 Docker image with Python 3.10+ support
# Based on: https://carla.readthedocs.io/en/latest/build_docker/

FROM carlasim/carla:0.9.16

# Switch to root for package installations (base image uses 'carla' user)
USER root

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV CARLA_ROOT=/workspace

# Update system packages
RUN apt-get update && apt-get install -y \
    python3-pip \
    python3-dev \
    git \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip and install build tools
RUN python3 -m pip install --upgrade pip setuptools==69.2.0 wheel

# Install CARLA Python API from the included wheel
# CARLA 0.9.16 wheels are built for Python 3.10, 3.11, 3.12
RUN python3 -m pip install /workspace/PythonAPI/carla/dist/carla-0.9.16-cp310-cp310-manylinux_2_31_x86_64.whl || \
    python3 -m pip install /workspace/PythonAPI/carla/dist/carla-0.9.16-cp311-cp311-manylinux_2_31_x86_64.whl || \
    python3 -m pip install /workspace/PythonAPI/carla/dist/carla-0.9.16-cp312-cp312-manylinux_2_31_x86_64.whl

# Install Gymnasium (modern OpenAI Gym replacement)
# Required for: src/environment/carla_env.py
RUN python3 -m pip install gymnasium==0.29.1

# Install PyTorch with CUDA 12.1 support (for RTX 2060 compatibility)
RUN python3 -m pip install torch==2.4.1 torchvision==0.19.1 --index-url https://download.pytorch.org/whl/cu121

# Install other Python dependencies
RUN python3 -m pip install \
    numpy==1.24.3 \
    opencv-python==4.8.1.78 \
    pyyaml==6.0.1 \
    tensorboard==2.15.0 \
    matplotlib==3.7.3 \
    pandas==2.0.3 \
    scikit-learn==1.3.2

# Verify all critical dependencies
RUN python3 -c "import carla; print(f'CARLA API: {carla.__version__}')" && \
    python3 -c "import gymnasium; print(f'Gymnasium: {gymnasium.__version__}')" && \
    python3 -c "import torch; print(f'PyTorch: {torch.__version__}, CUDA available: {torch.cuda.is_available()}')" && \
    python3 -c "import cv2; print(f'OpenCV: {cv2.__version__}')" && \
    python3 -c "import numpy; print(f'NumPy: {numpy.__version__}')" && \
    python3 -c "import yaml; print(f'PyYAML: {yaml.__version__}')"

# Create project directory
WORKDIR /workspace/av_td3_system

# Copy project files (will be mounted as volume in practice)
# COPY . /workspace/av_td3_system/

# Ensure CARLA server script is executable
RUN chmod +x /workspace/CarlaUE4.sh

# Expose CARLA default ports
EXPOSE 2000 2001

# Set default command (don't auto-start CARLA server - let user control it)
CMD ["/bin/bash"]
